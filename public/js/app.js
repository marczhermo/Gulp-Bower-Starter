/*!
 * Contact Form and AntiSpam Javascript Plugin
 * Author: Marcz Hermo
 * Email: marcz@lab1521.com
 * Copyright 2015 Lab1521 Limited
 *
 * Codes here can be used in production.
 * Although I have done some testing on the ff:
 *     1. $.Deferred() implementation
 *     2. Rx-JS with jQuery implementation
 */
smoothScroll.init({speed:1e3,easing:"easeInOutCubic",offset:0,updateURL:!0,callbackBefore:function(t,e){},callbackAfter:function(t,e){}}),function(t){"use strict";var e=function(e,s,n,o){this.$inputAnswer=e,this.$inputToken=s,this.$inputRefresh=n,this.$inputQuestion=o,this.answer="",this.token="",this.url="contact.php",this.deferred=t.Deferred(),this.init()};e.prototype.init=function(){this.reload(),this.$inputRefresh.on("click",this.reload.bind(this))},e.prototype.reload=function(){this.deferred=t.ajax({url:this.url,dataType:"json"}).promise(),this.deferred.always(this.update.bind(this)),this.deferred.always(this.sample.call(this)),this.deferred.always(function(t){console.log("func"),console.log(t)})},e.prototype.sample=function(){this.deferred.always(function(t){console.log("sample"),console.log(t)})},e.prototype.update=function(t){console.log("update"),console.log(t),this.$inputToken.val(t.client),this.$inputQuestion.text(t.question),this.$inputAnswer.val("")};var s=function(t,e){this.antiSpam=e,this.$form=t,this.url="contact.php",this.search=this.searchObservable()};s.prototype.searchWikipedia=function(e){return t.ajaxAsObservable({url:"http://en.wikipedia.org/w/api.php",data:{action:"opensearch",search:e,format:"json"},dataType:"jsonp"})},s.prototype.searchObservable=function(){var e=this,s=this.$form.find("#results"),n=this.$form.find("#search").keyupAsObservable().map(function(e){return t(e.target).val()}).filter(function(t){return t.length>2}).throttle(500).distinctUntilChanged(),o=n.flatMapLatest(function(t){return e.searchWikipedia(t)});o.subscribe(function(e){s.empty(),t.each(e.data[1],function(e,n){console.log(e),console.log(n),t("<li>"+n+"</li>").appendTo(s)})},function(e){s.empty(),console.log(e),t("<li>Error: HTTP:"+e.jqXHR.status+" - "+e.textStatus+"</li>").appendTo(s)})},s.prototype.post=function(e){t.when(t.ajax({url:this.url,data:e,dataType:"json",type:"POST"})).done(this.update.bind(this))},s.prototype.update=function(t){t.success===!0&&this.success(),this.warnings.call(this,t)},s.prototype.success=function(){var e=this.$form,s=e.find(".form-alert").show(),n=t(".alert",s).removeClass("alert-danger").addClass("alert-success");n.html("<strong>Success!</strong> We will contact you as soon as possible.");var o=e.find(".glyphicon");o.removeClass("glyphicon-remove glyphicon-ok").addClass("glyphicon-asterisk"),e.find("input").val(""),e.find("textarea").val("")},s.prototype.warnings=function(e){var s=e.notices,n=this;this.antiSpam.reload();for(var o=0;o<s.length;o++){var i=s[o];t.each(i,function(t,e){n.warn.call(n,t,e)})}},s.prototype.warn=function(t,e){var s=this.$form,n=s.find("[name="+t+"] ~ .glyphicon");n.length?n.removeClass("glyphicon-asterisk glyphicon-ok").addClass("glyphicon-remove"):"antiSpamAnswer"!=t&&"antiSpamToken"!=t&&this.showError.call(this,e)},s.prototype.showError=function(e){var s=this.$form,n=s.find(".form-alert").show(),o=t(".alert",n).removeClass("alert-success").addClass("alert-danger");o.html("<strong>Error!</strong> "+e)},s.prototype.hideAlert=function(){var e=this.$form,s=e.find(".form-alert").hide();t(".alert",s).removeClass("alert-success alert-danger").html("")},s.prototype.submit=function(t){var e=this.$form;this.hideAlert();for(var s=0;s<t.length;s++){var n=t[s],o=e.find("[name="+n.name+"] ~ .glyphicon");if(""==n.value)return o.removeClass("glyphicon-asterisk glyphicon-ok").addClass("glyphicon-remove"),void e.find("[name="+n.name+"]").focus();o.removeClass("glyphicon-asterisk glyphicon-remove").addClass("glyphicon-ok")}this.post.call(this,t)},t(function(){var n=new e(t("#antiSpamAnswer"),t("#antiSpamToken"),t("#antiSpamRefresh"),t("#antiSpamQuestion")),o=new s(t("#contactForm"),n);t("#contactForm").on("submit",function(e){o.submit.call(o,t(this).serializeArray()),e.preventDefault()})})}(jQuery);